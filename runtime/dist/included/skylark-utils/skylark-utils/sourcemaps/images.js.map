{"version":3,"sources":["images.js"],"names":["define","skylark","langx","ImagesLoaded","elem","options","onAlways","this","document","querySelectorAll","elements","makeArray","extend","on","getImages","$","jqDeferred","Deferred","setTimeout","check","bind","LoadingImage","img","Background","url","element","Image","images","prototype","Object","create","EvEmitter","forEach","addElementImages","nodeName","addImage","background","addElementBackgroundImages","nodeType","elementNodeTypes","childImgs","i","length","children","child","1","9","11","style","getComputedStyle","reURL","matches","exec","backgroundImage","addBackground","loadingImage","push","onProgress","image","message","_this","progress","progressedCount","hasAnyBroken","once","complete","isLoaded","emitEvent","notify","debug","console","log","eventName","isComplete","jqMethod","getIsImageComplete","confirm","naturalWidth","proxyImage","addEventListener","src","undefined","handleEvent","event","method","type","onload","unbindEvents","onerror","removeEventListener","mixin"],"mappings":"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","file":"../images.js","sourcesContent":["define([\r\n    \"./skylark\",\r\n    \"./langx\"\r\n], function(skylark,langx) {\r\n\r\n\r\n// -------------------------- imagesLoaded -------------------------- //\r\n\r\n/**\r\n * @param {Array, Element, NodeList, String} elem\r\n * @param {Object or Function} options - if function, use as callback\r\n * @param {Function} onAlways - callback function\r\n */\r\nfunction ImagesLoaded( elem, options, onAlways ) {\r\n  // coerce ImagesLoaded() without new, to be new ImagesLoaded()\r\n  if ( !( this instanceof ImagesLoaded ) ) {\r\n    return new ImagesLoaded( elem, options, onAlways );\r\n  }\r\n  // use elem as selector string\r\n  if ( typeof elem == 'string' ) {\r\n    elem = document.querySelectorAll( elem );\r\n  }\r\n\r\n  this.elements = makeArray( elem );\r\n  this.options = extend( {}, this.options );\r\n\r\n  if ( typeof options == 'function' ) {\r\n    onAlways = options;\r\n  } else {\r\n    extend( this.options, options );\r\n  }\r\n\r\n  if ( onAlways ) {\r\n    this.on( 'always', onAlways );\r\n  }\r\n\r\n  this.getImages();\r\n\r\n  if ( $ ) {\r\n    // add jQuery Deferred object\r\n    this.jqDeferred = new $.Deferred();\r\n  }\r\n\r\n  // HACK check async to allow time to bind listeners\r\n  setTimeout( function() {\r\n    this.check();\r\n  }.bind( this ));\r\n}\r\n\r\nImagesLoaded.prototype = Object.create( EvEmitter.prototype );\r\n\r\nImagesLoaded.prototype.options = {};\r\n\r\nImagesLoaded.prototype.getImages = function() {\r\n  this.images = [];\r\n\r\n  // filter & find items if we have an item selector\r\n  this.elements.forEach( this.addElementImages, this );\r\n};\r\n\r\n/**\r\n * @param {Node} element\r\n */\r\nImagesLoaded.prototype.addElementImages = function( elem ) {\r\n  // filter siblings\r\n  if ( elem.nodeName == 'IMG' ) {\r\n    this.addImage( elem );\r\n  }\r\n  // get background image on element\r\n  if ( this.options.background === true ) {\r\n    this.addElementBackgroundImages( elem );\r\n  }\r\n\r\n  // find children\r\n  // no non-element nodes, #143\r\n  var nodeType = elem.nodeType;\r\n  if ( !nodeType || !elementNodeTypes[ nodeType ] ) {\r\n    return;\r\n  }\r\n  var childImgs = elem.querySelectorAll('img');\r\n  // concat childElems to filterFound array\r\n  for ( var i=0; i < childImgs.length; i++ ) {\r\n    var img = childImgs[i];\r\n    this.addImage( img );\r\n  }\r\n\r\n  // get child background images\r\n  if ( typeof this.options.background == 'string' ) {\r\n    var children = elem.querySelectorAll( this.options.background );\r\n    for ( i=0; i < children.length; i++ ) {\r\n      var child = children[i];\r\n      this.addElementBackgroundImages( child );\r\n    }\r\n  }\r\n};\r\n\r\nvar elementNodeTypes = {\r\n  1: true,\r\n  9: true,\r\n  11: true\r\n};\r\n\r\nImagesLoaded.prototype.addElementBackgroundImages = function( elem ) {\r\n  var style = getComputedStyle( elem );\r\n  if ( !style ) {\r\n    // Firefox returns null if in a hidden iframe https://bugzil.la/548397\r\n    return;\r\n  }\r\n  // get url inside url(\"...\")\r\n  var reURL = /url\\((['\"])?(.*?)\\1\\)/gi;\r\n  var matches = reURL.exec( style.backgroundImage );\r\n  while ( matches !== null ) {\r\n    var url = matches && matches[2];\r\n    if ( url ) {\r\n      this.addBackground( url, elem );\r\n    }\r\n    matches = reURL.exec( style.backgroundImage );\r\n  }\r\n};\r\n\r\n/**\r\n * @param {Image} img\r\n */\r\nImagesLoaded.prototype.addImage = function( img ) {\r\n  var loadingImage = new LoadingImage( img );\r\n  this.images.push( loadingImage );\r\n};\r\n\r\nImagesLoaded.prototype.addBackground = function( url, elem ) {\r\n  var background = new Background( url, elem );\r\n  this.images.push( background );\r\n};\r\n\r\nImagesLoaded.prototype.check = function() {\r\n  var _this = this;\r\n  this.progressedCount = 0;\r\n  this.hasAnyBroken = false;\r\n  // complete if no images\r\n  if ( !this.images.length ) {\r\n    this.complete();\r\n    return;\r\n  }\r\n\r\n  function onProgress( image, elem, message ) {\r\n    // HACK - Chrome triggers event before object properties have changed. #83\r\n    setTimeout( function() {\r\n      _this.progress( image, elem, message );\r\n    });\r\n  }\r\n\r\n  this.images.forEach( function( loadingImage ) {\r\n    loadingImage.once( 'progress', onProgress );\r\n    loadingImage.check();\r\n  });\r\n};\r\n\r\nImagesLoaded.prototype.progress = function( image, elem, message ) {\r\n  this.progressedCount++;\r\n  this.hasAnyBroken = this.hasAnyBroken || !image.isLoaded;\r\n  // progress event\r\n  this.emitEvent( 'progress', [ this, image, elem ] );\r\n  if ( this.jqDeferred && this.jqDeferred.notify ) {\r\n    this.jqDeferred.notify( this, image );\r\n  }\r\n  // check if completed\r\n  if ( this.progressedCount == this.images.length ) {\r\n    this.complete();\r\n  }\r\n\r\n  if ( this.options.debug && console ) {\r\n    console.log( 'progress: ' + message, image, elem );\r\n  }\r\n};\r\n\r\nImagesLoaded.prototype.complete = function() {\r\n  var eventName = this.hasAnyBroken ? 'fail' : 'done';\r\n  this.isComplete = true;\r\n  this.emitEvent( eventName, [ this ] );\r\n  this.emitEvent( 'always', [ this ] );\r\n  if ( this.jqDeferred ) {\r\n    var jqMethod = this.hasAnyBroken ? 'reject' : 'resolve';\r\n    this.jqDeferred[ jqMethod ]( this );\r\n  }\r\n};\r\n\r\n// --------------------------  -------------------------- //\r\n\r\nfunction LoadingImage( img ) {\r\n  this.img = img;\r\n}\r\n\r\nLoadingImage.prototype = Object.create( EvEmitter.prototype );\r\n\r\nLoadingImage.prototype.check = function() {\r\n  // If complete is true and browser supports natural sizes,\r\n  // try to check for image status manually.\r\n  var isComplete = this.getIsImageComplete();\r\n  if ( isComplete ) {\r\n    // report based on naturalWidth\r\n    this.confirm( this.img.naturalWidth !== 0, 'naturalWidth' );\r\n    return;\r\n  }\r\n\r\n  // If none of the checks above matched, simulate loading on detached element.\r\n  this.proxyImage = new Image();\r\n  this.proxyImage.addEventListener( 'load', this );\r\n  this.proxyImage.addEventListener( 'error', this );\r\n  // bind to image as well for Firefox. #191\r\n  this.img.addEventListener( 'load', this );\r\n  this.img.addEventListener( 'error', this );\r\n  this.proxyImage.src = this.img.src;\r\n};\r\n\r\nLoadingImage.prototype.getIsImageComplete = function() {\r\n  return this.img.complete && this.img.naturalWidth !== undefined;\r\n};\r\n\r\nLoadingImage.prototype.confirm = function( isLoaded, message ) {\r\n  this.isLoaded = isLoaded;\r\n  this.emitEvent( 'progress', [ this, this.img, message ] );\r\n};\r\n\r\n// ----- events ----- //\r\n\r\n// trigger specified handler for event type\r\nLoadingImage.prototype.handleEvent = function( event ) {\r\n  var method = 'on' + event.type;\r\n  if ( this[ method ] ) {\r\n    this[ method ]( event );\r\n  }\r\n};\r\n\r\nLoadingImage.prototype.onload = function() {\r\n  this.confirm( true, 'onload' );\r\n  this.unbindEvents();\r\n};\r\n\r\nLoadingImage.prototype.onerror = function() {\r\n  this.confirm( false, 'onerror' );\r\n  this.unbindEvents();\r\n};\r\n\r\nLoadingImage.prototype.unbindEvents = function() {\r\n  this.proxyImage.removeEventListener( 'load', this );\r\n  this.proxyImage.removeEventListener( 'error', this );\r\n  this.img.removeEventListener( 'load', this );\r\n  this.img.removeEventListener( 'error', this );\r\n};\r\n\r\n// -------------------------- Background -------------------------- //\r\n\r\nfunction Background( url, element ) {\r\n  this.url = url;\r\n  this.element = element;\r\n  this.img = new Image();\r\n}\r\n\r\n// inherit LoadingImage prototype\r\nBackground.prototype = Object.create( LoadingImage.prototype );\r\n\r\nBackground.prototype.check = function() {\r\n  this.img.addEventListener( 'load', this );\r\n  this.img.addEventListener( 'error', this );\r\n  this.img.src = this.url;\r\n  // check if image is already complete\r\n  var isComplete = this.getIsImageComplete();\r\n  if ( isComplete ) {\r\n    this.confirm( this.img.naturalWidth !== 0, 'naturalWidth' );\r\n    this.unbindEvents();\r\n  }\r\n};\r\n\r\nBackground.prototype.unbindEvents = function() {\r\n  this.img.removeEventListener( 'load', this );\r\n  this.img.removeEventListener( 'error', this );\r\n};\r\n\r\nBackground.prototype.confirm = function( isLoaded, message ) {\r\n  this.isLoaded = isLoaded;\r\n  this.emitEvent( 'progress', [ this, this.element, message ] );\r\n};\r\n\r\n    function images() {\r\n        return images;\r\n    }\r\n\r\n    langx.mixin(images, {\r\n    });\r\n\r\n    return skylark.images = images;\r\n});\r\n"]}