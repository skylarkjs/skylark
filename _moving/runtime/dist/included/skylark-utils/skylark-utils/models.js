/**
 * skylark-utils - An Elegant HTML5 JavaScript Library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.5
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./skylark","./langx"],function(t,e){function i(){return i}var r={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"},n=function(t,n,s){var h=r[t];e.defaults(s||(s={}),{emulateHTTP:i.emulateHTTP,emulateJSON:i.emulateJSON});var a={type:h,dataType:"json"};if(s.url||(a.url=e.result(n,"url")||urlError()),null!=s.data||!n||"create"!==t&&"update"!==t&&"patch"!==t||(a.contentType="application/json",a.data=JSON.stringify(s.attrs||n.toJSON(s))),s.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.data=a.data?{entity:a.data}:{}),s.emulateHTTP&&("PUT"===h||"DELETE"===h||"PATCH"===h)){a.type="POST",s.emulateJSON&&(a.data._method=h);var o=s.beforeSend;s.beforeSend=function(t){if(t.setRequestHeader("X-HTTP-Method-Override",h),o)return o.apply(this,arguments)}}"GET"===a.type||s.emulateJSON||(a.processData=!1);var u=s.error;s.error=function(t,e,i){s.textStatus=e,s.errorThrown=i,u&&u.call(s.context,t,e,i)};var c=s.xhr=e.Xhr.request(e.mixin(a,s));return n.trigger("request",n,c,s),c},s=e.Stateful.inherit({sync:function(){return i.sync.apply(this,arguments)},matches:function(t){return e.isMatch(this.attributes,t)},fetch:function(t){t=e.mixin({parse:!0},t);var i=this,r=t.success;return t.success=function(e){var n=t.parse?i.parse(e,t):e;return!!i.set(n,t)&&(r&&r.call(t.context,i,e,t),void i.trigger("sync",i,e,t))},wrapError(this,t),this.sync("read",this,t)},save:function(t,i,r){var n;null==t||"object"==typeof t?(n=t,r=i):(n={})[t]=i,r=e.mixin({validate:!0,parse:!0},r);var s=r.wait;if(n&&!s){if(!this.set(n,r))return!1}else if(!this._validate(n,r))return!1;var h=this,a=r.success,o=this.attributes;r.success=function(t){h.attributes=o;var i=r.parse?h.parse(t,r):t;return s&&(i=e.mixin({},n,i)),!(i&&!h.set(i,r))&&(a&&a.call(r.context,h,t,r),void h.trigger("sync",h,t,r))},wrapError(this,r),n&&s&&(this.attributes=e.mixin({},o,n));var u=this.isNew()?"create":r.patch?"patch":"update";"patch"!==u||r.attrs||(r.attrs=n);var c=this.sync(u,this,r);return this.attributes=o,c},destroy:function(t){t=t?e.clone(t):{};var i=this,r=t.success,n=t.wait,s=function(){i.stopListening(),i.trigger("destroy",i,i.collection,t)};t.success=function(e){n&&s(),r&&r.call(t.context,i,e,t),i.isNew()||i.trigger("sync",i,e,t)};var h=!1;return this.isNew()?e.defer(t.success):(wrapError(this,t),h=this.sync("delete",this,t)),n||s(),h},url:function(){var t=e.result(this,"urlRoot")||e.result(this.collection,"url")||urlError();if(this.isNew())return t;var i=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(i)},parse:function(t,e){return t}}),h=e.Evented.inherit({init:function(t,i){i||(i={}),i.entity&&(this.entity=i.entity),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),t&&this.reset(t,e.mixin({silent:!0},i))}}),a={add:!0,remove:!0,merge:!0},o={add:!0,remove:!1},u=function(t,e,i){i=Math.min(Math.max(i,0),t.length);var r,n=Array(t.length-i),s=e.length;for(r=0;r<n.length;r++)n[r]=t[r+i];for(r=0;r<s;r++)t[r+i]=e[r];for(r=0;r<n.length;r++)t[r+s+i]=n[r]};return h.partial({entity:s,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return i.sync.apply(this,arguments)},add:function(t,i){return this.set(t,e.mixin({merge:!1},i,o))},remove:function(t,i){i=e.mixin({},i);var r=!e.isArray(t);t=r?[t]:t.slice();var n=this._removeEntitys(t,i);return!i.silent&&n.length&&(i.changes={added:[],merged:[],removed:n},this.trigger("update",this,i)),r?n[0]:n},set:function(t,i){if(null!=t){i=e.mixin({},a,i),i.parse&&!this._isEntity(t)&&(t=this.parse(t,i)||[]);var r=!e.isArray(t);t=r?[t]:t.slice();var n=i.at;null!=n&&(n=+n),n>this.length&&(n=this.length),n<0&&(n+=this.length+1);var s,h,o=[],c=[],l=[],d=[],f={},p=i.add,g=i.merge,y=i.remove,v=!1,m=this.comparator&&null==n&&i.sort!==!1,E=e.isString(this.comparator)?this.comparator:null;for(h=0;h<t.length;h++){s=t[h];var _=this.get(s);if(_){if(g&&s!==_){var b=this._isEntity(s)?s.attributes:s;i.parse&&(b=_.parse(b,i)),_.set(b,i),l.push(_),m&&!v&&(v=_.hasChanged(E))}f[_.cid]||(f[_.cid]=!0,o.push(_)),t[h]=_}else p&&(s=t[h]=this._prepareEntity(s,i),s&&(c.push(s),this._addReference(s,i),f[s.cid]=!0,o.push(s)))}if(y){for(h=0;h<this.length;h++)s=this.entities[h],f[s.cid]||d.push(s);d.length&&this._removeEntitys(d,i)}var x=!1,T=!m&&p&&y;if(o.length&&T?(x=this.length!==o.length||this.entities.some(function(t,e){return t!==o[e]}),this.entities.length=0,u(this.entities,o,0),this.length=this.entities.length):c.length&&(m&&(v=!0),u(this.entities,c,null==n?this.length:n),this.length=this.entities.length),v&&this.sort({silent:!0}),!i.silent){for(h=0;h<c.length;h++)null!=n&&(i.index=n+h),s=c[h],s.trigger("add",s,this,i);(v||x)&&this.trigger("sort",this,i),(c.length||d.length||l.length)&&(i.changes={added:c,removed:d,merged:l},this.trigger("update",this,i))}return r?t[0]:t}},reset:function(t,i){i=i?e.clone(i):{};for(var r=0;r<this.entities.length;r++)this._removeReference(this.entities[r],i);return i.previousEntitys=this.entities,this._reset(),t=this.add(t,e.mixin({silent:!0},i)),i.silent||this.trigger("reset",this,i),t},push:function(t,i){return this.add(t,e.mixin({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(t,i){return this.add(t,e.mixin({at:0},i))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.entities,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.entityId(t.attributes||t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.entities[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(t){var i=this.comparator;if(!i)throw new Error("Cannot sort a set without a comparator");t||(t={});var r=i.length;return e.isFunction(i)&&(i=e.proxy(i,this)),1===r||e.isString(i)?this.entities=this.sortBy(i):this.entities.sort(i),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return this.map(t+"")},fetch:function(t){t=e.mixin({parse:!0},t);var i=t.success,r=this;return t.success=function(e){var n=t.reset?"reset":"set";r[n](e,t),i&&i.call(t.context,r,e,t),r.trigger("sync",r,e,t)},wrapError(this,t),this.sync("read",this,t)},create:function(t,i){i=i?e.clone(i):{};var r=i.wait;if(t=this._prepareEntity(t,i),!t)return!1;r||this.add(t,i);var n=this,s=i.success;return i.success=function(t,e,i){r&&n.add(t,i),s&&s.call(i.context,t,e,i)},t.save(null,i),t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.entities,{entity:this.entity,comparator:this.comparator})},entityId:function(t){return t[this.entity.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.entities=[],this._byId={}},_prepareEntity:function(t,i){if(this._isEntity(t))return t.collection||(t.collection=this),t;i=i?e.clone(i):{},i.collection=this;var r=new this.entity(t,i);return r.validationError?(this.trigger("invalid",this,r.validationError,i),!1):r},_removeEntitys:function(t,e){for(var i=[],r=0;r<t.length;r++){var n=this.get(t[r]);if(n){var s=this.indexOf(n);this.entities.splice(s,1),this.length--,delete this._byId[n.cid];var h=this.entityId(n.attributes);null!=h&&delete this._byId[h],e.silent||(e.index=s,n.trigger("remove",n,this,e)),i.push(n),this._removeReference(n,e)}}return i},_isEntity:function(t){return t instanceof s},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.entityId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onEntityEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var i=this.entityId(t.attributes);null!=i&&delete this._byId[i],this===t.collection&&delete t.collection,t.off("all",this._onEntityEvent,this)},_onEntityEvent:function(t,e,i,r){if(e){if(("add"===t||"remove"===t)&&i!==this)return;if("destroy"===t&&this.remove(e,r),"change"===t){var n=this.entityId(e.previousAttributes()),s=this.entityId(e.attributes);n!==s&&(null!=n&&delete this._byId[n],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}}),e.mixin(i,{emulateHTTP:!1,emulateJSON:!1,sync:n,Entity:s,Collection:h}),t.models=i});
//# sourceMappingURL=sourcemaps/models.js.map
