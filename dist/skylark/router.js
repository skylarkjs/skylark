/**
 * skylark - An Elegant JavaScript Library and HTML5 Application Framework.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark/skylark","skylark/langx","skylark/browser","skylark/datax","skylark/eventer","skylark/async"],function(t,e,r,n,i,a){function o(){return w}function u(t){if(x){var e=x.route.exit({path:x.path,params:x.params},!0);if(!e)return}if(x=w,w=t,!w.route){var r=h(w.path);w.route=r.route,w.params=r.params}var n=w.route.enter({path:w.path,params:w.params},!0);a.Deferred.when(n).then(function(){i.trigger(_,"routing",{current:w,previous:x}),w.route.enter({path:w.path,params:w.params},!1),x&&x.route.exit({path:x.path,params:x.params},!1),i.trigger(_,"routed",{current:w,previous:x})})}function s(t,e){if(!e&&w&&w.path==t)return!1;var r=h(t);if(r)if(r.path=t,D.useHistoryApi){var n={path:t};window.history.pushState(n,document.title,(y+t).replace("//","/")),i.trigger(window,i.create("popstate",{state:n}))}else if(D.useHashbang){var a="#!"+t;window.location.hash!==a?window.location.hash=a:u(r)}else u(r);return!0}function h(t,r){var n=!1;return!r&&(n=H[t])?n:(e.each(b,function(e,r){var i=r.match(t);return!i||(n={route:r,params:i},!1)}),n&&!r&&(H[t]=n),n)}function c(t,e){var r,n=b[t];return n&&(r=n.path(e)),r}function p(){return x}function f(t){return e.isDefined(t)?(y=t,this):y}function l(){return _}function g(t){return e.isDefined(t)?(k=t,this):k}function d(t,r){if(e.isDefined(r)){var n={};return n[t]=r,m(n),this}return b[t]}function m(t){if(!e.isDefined(t))return e.mixin({},b);for(var r in t)b[r]=new D.Route(r,t[r])}function v(){null==D.useHashbang&&null==D.useHistoryApi&&(window.location.host?D.useHistoryApi=!0:D.useHashbang=!0);var t;D.useHistoryApi?(t=window.location.pathname,void 0===y&&(y=t.replace(/\/$/,"")),t=t.replace(y,"")||k||"/"):t=D.useHashbang?window.location.hash.replace("#!","")||k||"/":"/",i.on(document.body,"click","a[href]",function(t){var r=t.currentTarget,a=n.attr(r,"href");"#"!=a&&a&&e.isSameOrigin(r.href)&&0===a.indexOf(y)&&(a=a.substr(y.length),i.stop(t),a=a.replace("#!",""),s(a))}),D.useHistoryApi?i.on(window,"popstate",function(t){t.state&&u(t.state),i.stop(t)}):D.useHashbang&&i.on(window,"hashchange",function(t){u({path:window.location.hash.replace(/^#!/,"")}),i.stop(t)}),s(t)}var w,x,y,k,b={},H={},_=new e.Evented,A=e.Evented.inherit({klassName:"Route",init:function(t,r){r=e.mixin({},r);var n=r.pathto||"",i=n,a=i.match(/\:([a-zA-Z0-9_]+)/g);null!==a?(a=a.map(function(t){return t.substring(1)}),i=i.replace(/\:([a-zA-Z0-9_]+)/g,"(.*?)")):a=[],i="*"===i?"(.*)":i.replace("/","\\/"),this._setting=r,this.name=t,this.pathto=n,this.paramNames=a,this.params=i,this.regex=new RegExp("^"+i+"$","");var o=this;["entering","entered","exiting","exited"].forEach(function(t){e.isFunction(r[t])&&o.on(t,r[t])})},enter:function(t,r){if(r){var n=this._entering(t);return a.Deferred.when(n).then(function(){var t=i.create("entering",{route:this,result:!0});return i.trigger(this,t),t.result})}return this._entered(t),i.trigger(this,"entered",e.safeMixin({route:this},t)),this},exit:function(t,r){if(r){var n=this._exiting(t);if(!n)return!1;var a=i.create("exiting",{route:this,result:!0});return i.trigger(this,a),a.result}return this._exited(t),i.trigger(this,"exited",e.safeMixin({route:this},t)),this},match:function(t){var e=this.paramNames,r=t.indexOf("?"),t=~r?t.slice(0,r):decodeURIComponent(t),n=this.regex.exec(t);if(!n)return!1;for(var i={},a=1,o=n.length;a<o;++a){var u=e[a-1],s=decodeURIComponent(n[a]);i[u]=s}return i},path:function(t){var e=this.pathto;return t&&(e=e.replace(/:([a-zA-Z0-9_]+)/g,function(e,r){return t[r]})),e},_entering:function(t){return!0},_entered:function(t){return!0},_exiting:function(t){return!0},_exited:function(t){return!0}}),D=function(){return D};return e.mixin(D,{Route:A,current:o,go:s,map:h,hub:l,off:function(){_.off.apply(_,arguments)},on:function(){_.on.apply(_,arguments)},one:function(){_.one.apply(_,arguments)},path:c,previous:p,baseUrl:f,homePath:g,route:d,routes:m,start:v,trigger:function(t,e){return i.trigger(_,t,e),this},useHistoryApi:null,useHashbang:null}),t.router=D});