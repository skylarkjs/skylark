/**
 * skylark-utils - An Elegant HTML5 JavaScript Library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.5-beta
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./skylark","./langx","./ajax"],function(t,e,i){function r(){return r}var n={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"},s=function(t,s,a){var h=n[t];e.defaults(a||(a={}),{emulateHTTP:r.emulateHTTP,emulateJSON:r.emulateJSON});var o={type:h,dataType:"json"};if(a.url||(o.url=e.result(s,"url")||urlError()),null!=a.data||!s||"create"!==t&&"update"!==t&&"patch"!==t||(o.contentType="application/json",o.data=JSON.stringify(a.attrs||s.toJSON(a))),a.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{entity:o.data}:{}),a.emulateHTTP&&("PUT"===h||"DELETE"===h||"PATCH"===h)){o.type="POST",a.emulateJSON&&(o.data._method=h);var u=a.beforeSend;a.beforeSend=function(t){if(t.setRequestHeader("X-HTTP-Method-Override",h),u)return u.apply(this,arguments)}}"GET"===o.type||a.emulateJSON||(o.processData=!1);var c=a.error;a.error=function(t,e,i){a.textStatus=e,a.errorThrown=i,c&&c.call(a.context,t,e,i)};var l=a.xhr=i(e.mixin(o,a));return s.trigger("request",s,l,a),l},a=e.Stateful.inherit({sync:function(){return r.sync.apply(this,arguments)},matches:function(t){return e.isMatch(this.attributes,t)},fetch:function(t){t=e.mixin({parse:!0},t);var i=this,r=t.success;return t.success=function(e){var n=t.parse?i.parse(e,t):e;return!!i.set(n,t)&&(r&&r.call(t.context,i,e,t),void i.trigger("sync",i,e,t))},wrapError(this,t),this.sync("read",this,t)},save:function(t,i,r){var n;null==t||"object"==typeof t?(n=t,r=i):(n={})[t]=i,r=e.mixin({validate:!0,parse:!0},r);var s=r.wait;if(n&&!s){if(!this.set(n,r))return!1}else if(!this._validate(n,r))return!1;var a=this,h=r.success,o=this.attributes;r.success=function(t){a.attributes=o;var i=r.parse?a.parse(t,r):t;return s&&(i=e.mixin({},n,i)),!(i&&!a.set(i,r))&&(h&&h.call(r.context,a,t,r),void a.trigger("sync",a,t,r))},wrapError(this,r),n&&s&&(this.attributes=e.mixin({},o,n));var u=this.isNew()?"create":r.patch?"patch":"update";"patch"!==u||r.attrs||(r.attrs=n);var c=this.sync(u,this,r);return this.attributes=o,c},destroy:function(t){t=t?e.clone(t):{};var i=this,r=t.success,n=t.wait,s=function(){i.stopListening(),i.trigger("destroy",i,i.collection,t)};t.success=function(e){n&&s(),r&&r.call(t.context,i,e,t),i.isNew()||i.trigger("sync",i,e,t)};var a=!1;return this.isNew()?e.defer(t.success):(wrapError(this,t),a=this.sync("delete",this,t)),n||s(),a},url:function(){var t=e.result(this,"urlRoot")||e.result(this.collection,"url")||urlError();if(this.isNew())return t;var i=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(i)},parse:function(t,e){return t}}),h=e.Evented.inherit({init:function(t,i){i||(i={}),i.entity&&(this.entity=i.entity),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),t&&this.reset(t,e.mixin({silent:!0},i))}}),o={add:!0,remove:!0,merge:!0},u={add:!0,remove:!1},c=function(t,e,i){i=Math.min(Math.max(i,0),t.length);var r,n=Array(t.length-i),s=e.length;for(r=0;r<n.length;r++)n[r]=t[r+i];for(r=0;r<s;r++)t[r+i]=e[r];for(r=0;r<n.length;r++)t[r+s+i]=n[r]};return h.partial({entity:a,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return r.sync.apply(this,arguments)},add:function(t,i){return this.set(t,e.mixin({merge:!1},i,u))},remove:function(t,i){i=e.mixin({},i);var r=!e.isArray(t);t=r?[t]:t.slice();var n=this._removeEntitys(t,i);return!i.silent&&n.length&&(i.changes={added:[],merged:[],removed:n},this.trigger("update",this,i)),r?n[0]:n},set:function(t,i){if(null!=t){i=e.mixin({},o,i),i.parse&&!this._isEntity(t)&&(t=this.parse(t,i)||[]);var r=!e.isArray(t);t=r?[t]:t.slice();var n=i.at;null!=n&&(n=+n),n>this.length&&(n=this.length),n<0&&(n+=this.length+1);var s,a,h=[],u=[],l=[],d=[],f={},p=i.add,g=i.merge,y=i.remove,v=!1,m=this.comparator&&null==n&&i.sort!==!1,E=e.isString(this.comparator)?this.comparator:null;for(a=0;a<t.length;a++){s=t[a];var _=this.get(s);if(_){if(g&&s!==_){var x=this._isEntity(s)?s.attributes:s;i.parse&&(x=_.parse(x,i)),_.set(x,i),l.push(_),m&&!v&&(v=_.hasChanged(E))}f[_.cid]||(f[_.cid]=!0,h.push(_)),t[a]=_}else p&&(s=t[a]=this._prepareEntity(s,i),s&&(u.push(s),this._addReference(s,i),f[s.cid]=!0,h.push(s)))}if(y){for(a=0;a<this.length;a++)s=this.entities[a],f[s.cid]||d.push(s);d.length&&this._removeEntitys(d,i)}var b=!1,T=!m&&p&&y;if(h.length&&T?(b=this.length!==h.length||this.entities.some(function(t,e){return t!==h[e]}),this.entities.length=0,c(this.entities,h,0),this.length=this.entities.length):u.length&&(m&&(v=!0),c(this.entities,u,null==n?this.length:n),this.length=this.entities.length),v&&this.sort({silent:!0}),!i.silent){for(a=0;a<u.length;a++)null!=n&&(i.index=n+a),s=u[a],s.trigger("add",s,this,i);(v||b)&&this.trigger("sort",this,i),(u.length||d.length||l.length)&&(i.changes={added:u,removed:d,merged:l},this.trigger("update",this,i))}return r?t[0]:t}},reset:function(t,i){i=i?e.clone(i):{};for(var r=0;r<this.entities.length;r++)this._removeReference(this.entities[r],i);return i.previousEntitys=this.entities,this._reset(),t=this.add(t,e.mixin({silent:!0},i)),i.silent||this.trigger("reset",this,i),t},push:function(t,i){return this.add(t,e.mixin({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(t,i){return this.add(t,e.mixin({at:0},i))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.entities,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.entityId(t.attributes||t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.entities[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(t){var i=this.comparator;if(!i)throw new Error("Cannot sort a set without a comparator");t||(t={});var r=i.length;return e.isFunction(i)&&(i=e.proxy(i,this)),1===r||e.isString(i)?this.entities=this.sortBy(i):this.entities.sort(i),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return this.map(t+"")},fetch:function(t){t=e.mixin({parse:!0},t);var i=t.success,r=this;return t.success=function(e){var n=t.reset?"reset":"set";r[n](e,t),i&&i.call(t.context,r,e,t),r.trigger("sync",r,e,t)},wrapError(this,t),this.sync("read",this,t)},create:function(t,i){i=i?e.clone(i):{};var r=i.wait;if(t=this._prepareEntity(t,i),!t)return!1;r||this.add(t,i);var n=this,s=i.success;return i.success=function(t,e,i){r&&n.add(t,i),s&&s.call(i.context,t,e,i)},t.save(null,i),t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.entities,{entity:this.entity,comparator:this.comparator})},entityId:function(t){return t[this.entity.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.entities=[],this._byId={}},_prepareEntity:function(t,i){if(this._isEntity(t))return t.collection||(t.collection=this),t;i=i?e.clone(i):{},i.collection=this;var r=new this.entity(t,i);return r.validationError?(this.trigger("invalid",this,r.validationError,i),!1):r},_removeEntitys:function(t,e){for(var i=[],r=0;r<t.length;r++){var n=this.get(t[r]);if(n){var s=this.indexOf(n);this.entities.splice(s,1),this.length--,delete this._byId[n.cid];var a=this.entityId(n.attributes);null!=a&&delete this._byId[a],e.silent||(e.index=s,n.trigger("remove",n,this,e)),i.push(n),this._removeReference(n,e)}}return i},_isEntity:function(t){return t instanceof a},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.entityId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onEntityEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var i=this.entityId(t.attributes);null!=i&&delete this._byId[i],this===t.collection&&delete t.collection,t.off("all",this._onEntityEvent,this)},_onEntityEvent:function(t,e,i,r){if(e){if(("add"===t||"remove"===t)&&i!==this)return;if("destroy"===t&&this.remove(e,r),"change"===t){var n=this.entityId(e.previousAttributes()),s=this.entityId(e.attributes);n!==s&&(null!=n&&delete this._byId[n],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}}),e.mixin(r,{emulateHTTP:!1,emulateJSON:!1,sync:s,Entity:a,Collection:h}),t.models=r});
//# sourceMappingURL=sourcemaps/models.js.map
