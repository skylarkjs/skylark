{"version":3,"sources":["filer.js"],"names":["define","skylark","langx","eventer","styler","selectFile","callback","selectFiles","pickedFiles","i","length","size","maxFileSize","splice","fileSelected","fileInput","input","document","createElement","type","style","position","left","top","opacity","body","appendChild","onchange","e","Array","prototype","slice","call","target","files","value","click","on","Deferred","attr","filer","mixin","dropzone","elm","params","hoverClass","droppedCallback","dropped","enterdCount","dataTransfer","types","indexOf","stop","addClass","removeClass","this","picker","pickedCallback","picked","preventDefault","readFile","file","d","reader","FileReader","onload","evt","resolve","result","onerror","code","error","alert","asArrayBuffer","readAsArrayBuffer","asDataUrl","readAsDataURL","asText","readAsText","promise","writeFile","data","name","window","navigator","msSaveBlob","isString","dataURItoBlob","a","Blob","URL","createObjectURL","href","setAttribute","dispatchEvent","CustomEvent"],"mappings":";;;;;;;AAAAA,QACI,YACA,UACA,YACA,YACD,SAASC,EAASC,EAAOC,EAAQC,GAmBhC,QAASC,GAAWC,GAKZ,QAASC,GAAYC,GACjB,IAAK,GAAIC,GAAID,EAAYE,OAAQD,KACzBD,EAAYC,GAAGE,KAAOC,GACtBJ,EAAYK,OAAOJ,EAAG,EAG9BK,GAAaN,GATrB,GADAM,EAAeR,GACVS,EAAW,CACZ,GAAIC,GAAQD,EAAYE,SAASC,cAAc,QAW/CF,GAAMG,KAAO,OACbH,EAAMI,MAAMC,SAAW,QACnBL,EAAMI,MAAME,KAAO,EACnBN,EAAMI,MAAMG,IAAM,EAClBP,EAAMI,MAAMI,QAAU,KACtBP,SAASQ,KAAKC,YAAYV,GAE9BA,EAAMW,SAAW,SAASC,GACtBrB,EAAYsB,MAAMC,UAAUC,MAAMC,KAAKJ,EAAEK,OAAOC,QAEhDlB,EAAMmB,MAAQ,IAGtBpB,EAAUqB,QA7Cd,GAIIrB,GAEAD,EANAuB,EAAKlC,EAAQkC,GAEbC,GADOnC,EAAQoC,KACJrC,EAAMoC,UAKjB1B,EAAc,EAAI,EA6MlB4B,EAAQ,WACR,MAAOA,GA8GX,OA3GAtC,GAAMuC,MAAMD,GACRE,SAAU,SAASC,EAAKC,GACpBA,EAASA,KACT,IAAIC,GAAaD,EAAOC,YAAc,WAClCC,EAAkBF,EAAOG,QAEzBC,EAAc,CAoClB,OAnCAX,GAAGM,EAAK,YAAa,SAASf,GACtBA,EAAEqB,cAAgBrB,EAAEqB,aAAaC,MAAMC,QAAQ,cAC/ChD,EAAQiD,KAAKxB,GACboB,IACA5C,EAAOiD,SAASV,EAAIE,MAI5BR,EAAGM,EAAK,WAAY,SAASf,GACrBA,EAAEqB,cAAgBrB,EAAEqB,aAAaC,MAAMC,QAAQ,aAC/ChD,EAAQiD,KAAKxB,KAKrBS,EAAGM,EAAK,YAAa,SAASf,GACtBA,EAAEqB,cAAgBrB,EAAEqB,aAAaC,MAAMC,QAAQ,cAC/CH,IACiB,GAAbA,GACA5C,EAAOkD,YAAYX,EAAIE,MAKnCR,EAAGM,EAAK,OAAQ,SAASf,GACjBA,EAAEqB,cAAgBrB,EAAEqB,aAAaC,MAAMC,QAAQ,cAC/C/C,EAAOkD,YAAYX,EAAIE,GACvB1C,EAAQiD,KAAKxB,GACTkB,GACAA,EAAgBlB,EAAEqB,aAAaf,UAMpCqB,MAGXC,OAAQ,SAASb,EAAKC,GAClBA,EAASA,KAET,IAAIa,GAAiBb,EAAOc,MAM5B,OAJArB,GAAGM,EAAK,QAAS,SAASf,GACtBA,EAAE+B,iBACFtD,EAAWoD,KAERF,MAGXK,SAAW,SAASC,EAAKjB,GACrBA,EAASA,KACT,IAAIkB,GAAI,GAAIxB,GACRyB,EAAS,GAAIC,WAwBjB,OAtBAD,GAAOE,OAAS,SAASC,GACrBJ,EAAEK,QAAQD,EAAIjC,OAAOmC,SAEzBL,EAAOM,QAAU,SAASzC,GACtB,GAAI0C,GAAO1C,EAAEK,OAAOsC,MAAMD,IACb,KAATA,EACAE,MAAM,uDAENA,MAAM,eAAiBF,IAI3B1B,EAAO6B,cACPV,EAAOW,kBAAkBb,GAClBjB,EAAO+B,UACdZ,EAAOa,cAAcf,GACdjB,EAAOiC,OACdd,EAAOe,WAAWjB,GAElBE,EAAOW,kBAAkBb,GAGtBC,EAAEiB,SAGbC,UAAY,SAASC,EAAKC,GACtB,GAAIC,OAAOC,UAAUC,WACdnF,EAAMoF,SAASL,KACfA,EAAOM,cAAcN,IAEzBE,OAAOC,UAAUC,WAAWJ,EAAMC,OAC9B,CACH,GAAIM,GAAIvE,SAASC,cAAc,IAC3B+D,aAAgBQ,QAChBR,EAAO/E,EAAMwF,IAAIC,gBAAgBV,IAErCO,EAAEI,KAAOX,EACTO,EAAEK,aAAa,WAAYX,GAAQ,UACnCM,EAAEM,cAAc,GAAIC,aAAY,cAOrC9F,EAAQuC,MAAQA","file":"../filer.js","sourcesContent":["define([\r\n    \"./skylark\",\r\n    \"./langx\",\r\n    \"./eventer\",\r\n    \"./styler\"\r\n], function(skylark, langx, eventer,styler) {\r\n    var on = eventer.on,\r\n        attr = eventer.attr,\r\n        Deferred = langx.Deferred,\r\n\r\n        fileInput,\r\n        fileInputForm,\r\n        fileSelected,\r\n        maxFileSize = 1 / 0;\r\n\r\n    function dataURLtoBlob(dataurl) {\r\n        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],\r\n            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);\r\n        while(n--){\r\n            u8arr[n] = bstr.charCodeAt(n);\r\n        }\r\n        return new Blob([u8arr], {type:mime});\r\n    }\r\n\r\n    function selectFile(callback) {\r\n        fileSelected = callback;\r\n        if (!fileInput) {\r\n            var input = fileInput = document.createElement(\"input\");\r\n\r\n            function selectFiles(pickedFiles) {\r\n                for (var i = pickedFiles.length; i--;) {\r\n                    if (pickedFiles[i].size > maxFileSize) {\r\n                        pickedFiles.splice(i, 1);\r\n                    }\r\n                }\r\n                fileSelected(pickedFiles);\r\n            }\r\n\r\n            input.type = \"file\";\r\n            input.style.position = \"fixed\",\r\n                input.style.left = 0,\r\n                input.style.top = 0,\r\n                input.style.opacity = .001,\r\n                document.body.appendChild(input);\r\n\r\n            input.onchange = function(e) {\r\n                selectFiles(Array.prototype.slice.call(e.target.files));\r\n                // reset to \"\", so selecting the same file next time still trigger the change handler\r\n                input.value = \"\";\r\n            };\r\n        }\r\n        fileInput.click();\r\n    }\r\n\r\n    function upload(files, url, params) {\r\n        params = params || {};\r\n        var chunkSize = params.chunkSize || 0,\r\n            maxSize = params.maxSize || 0,\r\n            progressCallback = params.progress,\r\n            errorCallback = params.error,\r\n            completedCallback = params.completed,\r\n            uploadedCallback = params.uploaded;\r\n\r\n\r\n        function uploadOneFile(fileItem,oneFileloadedSize, fileItems) {\r\n            function handleProcess(nowLoadedSize) {\r\n                var t;\r\n                speed = Math.ceil(oneFileloadedSize + nowLoadedSize / ((now() - uploadStartedTime) / 1e3)), \r\n                percent = Math.round((oneFileloadedSize + nowLoadedSize) / file.size * 100); \r\n                if (progressCallback) {\r\n                    progressCallback({\r\n                        name: file.name,\r\n                        loaded: oneFileloadedSize + nowLoadedSize,\r\n                        total: file.size,\r\n                        percent: percent,\r\n                        bytesPerSecond: speed,\r\n                        global: {\r\n                            loaded: allLoadedSize + oneFileloadedSize + nowLoadedSize,\r\n                            total: totalSize\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n            var file = fileItem.file,\r\n                uploadChunkSize = chunkSize || file.size,\r\n                chunk = file.slice(oneFileloadedSize, oneFileloadedSize + uploadChunkSize);\r\n\r\n            xhr = createXmlHttpRequest();\r\n            //xhr.open(\"POST\", url + \r\n            //                \"?action=upload&path=\" + \r\n            //                encodeURIComponent(path) + \r\n            //                \"&name=\" + encodeURIComponent(file.name) + \r\n            //                \"&loaded=\" + oneFileloadedSize + \r\n            //                \"&total=\" + file.size + \r\n            //                \"&id=\" + id + \r\n            //                \"&csrf=\" + encodeURIComponent(token) + \r\n            //                \"&resolution=\" + \r\n            //                encodeURIComponent(fileItem.type));\r\n            xhr.upload.onprogress = function(event) {\r\n                handleProcess(event.loaded - (event.total - h.size))\r\n            };\r\n            xhr.onload = function() {\r\n                var response, i;\r\n                xhr.upload.onprogress({\r\n                    loaded: h.size,\r\n                    total: h.size\r\n                });\r\n                try {\r\n                    response = JSON.parse(xhr.responseText);\r\n                } catch (e) {\r\n                    i = {\r\n                        code: -1,\r\n                        message: \"Error response is not proper JSON\\n\\nResponse:\\n\" + xhr.responseText,\r\n                        data: {\r\n                            fileName: file.name,\r\n                            fileSize: file.size,\r\n                            maxSize: uploadMaxSize,\r\n                            extensions: extensions.join(\", \")\r\n                        },\r\n                        extra: extra\r\n                    };\r\n                    errorFileInfos.push(i);\r\n                    if (errorCallback) {\r\n                        errorCallback(i);\r\n                    }\r\n                    return uploadFiles(fileItems)\r\n                }\r\n                if (response.error) {\r\n\r\n                    i = {\r\n                        code: response.error.code,\r\n                        message: response.error.message,\r\n                        data: {\r\n                            fileName: file.name,\r\n                            fileSize: file.size,\r\n                            maxSize: uploadMaxSize,\r\n                            extensions: extensions.join(\", \")\r\n                        },\r\n                        extra: extra\r\n                    }; \r\n                    errorFileInfos.push(i); \r\n                    if (errorCallback) {\r\n                        errorCallback(i);\r\n                    }\r\n                    uploadFiles(fileItems);\r\n                } else {\r\n                    if (!response.error && oneFileloadedSize + uploadChunkSize < file.size) {\r\n                        uploadOneFile(fileItem, oneFileloadedSize + uploadChunkSize, fileItems);\r\n                    } else {\r\n                        if (response.result) {\r\n                            utils.each(response.result, function(e) {\r\n                                e = File.fromJSON(e);\r\n                                uploadFileItems.push(e);\r\n\r\n                                if (uploadedCallback) {\r\n                                    uploadedCallback({\r\n                                        file: e\r\n                                    });\r\n                                }\r\n                            }); \r\n\r\n                        } \r\n                        allLoadedSize += file.size;\r\n                        response.result && k.push(response.result);\r\n                        uploadFiles(fileItems);\r\n                    }                            \r\n                }     \r\n\r\n            };\r\n            handleProcess(0);\r\n            xhr.send(createFormData(h));\r\n        }\r\n\r\n        function uploadFiles(fileItems) {\r\n            var fileItem = fileItems.shift();\r\n            processedFilesCount++; \r\n            if (fileItem && fileItem.file.error) {\r\n                uploadFiles(fileItem);\r\n            } else {\r\n                if (uploadingFile) {\r\n                    uploadOneFile(fileItem, null, 0, fileItems);\r\n                } else {\r\n\r\n                    if (completedCallback) {\r\n                        completedCallback({\r\n                            files: new FileCollection(uploadFileItems),\r\n                            bytesPerSecond: I,\r\n                            errors: E(D),\r\n                            extra: extra\r\n                        });\r\n                    }\r\n                }  \r\n            }\r\n        }\r\n\r\n        var self = this,\r\n            fileItems = [],\r\n            processedFilesCount = -1,\r\n            xhr, \r\n            totalSize = 0,\r\n            allLoadedSize = 0,\r\n            k = [],\r\n            errorFileInfos = [],\r\n            startedTime = now(),\r\n            I = 0,\r\n            uploadFileItems = [];\r\n\r\n        for ( var  i = 0; i < files.length; i++) {\r\n            totalSize += files[i].size;\r\n            fileItems.push({\r\n                file : files[i]\r\n            });\r\n        }        \r\n\r\n        uploadFiles(fileItems);\r\n    }\r\n\r\n\r\n    var filer = function() {\r\n        return filer;\r\n    };\r\n\r\n    langx.mixin(filer , {\r\n        dropzone: function(elm, params) {\r\n            params = params || {};\r\n            var hoverClass = params.hoverClass || \"dropzone\",\r\n                droppedCallback = params.dropped;\r\n\r\n            var enterdCount = 0;\r\n            on(elm, \"dragenter\", function(e) {\r\n                if (e.dataTransfer && e.dataTransfer.types.indexOf(\"Files\")>-1) {\r\n                    eventer.stop(e);\r\n                    enterdCount ++;\r\n                    styler.addClass(elm,hoverClass)\r\n                }\r\n            });\r\n\r\n            on(elm, \"dragover\", function(e) {\r\n                if (e.dataTransfer && e.dataTransfer.types.indexOf(\"Files\")>-1) {\r\n                    eventer.stop(e);\r\n                }\r\n            });\r\n\r\n\r\n            on(elm, \"dragleave\", function(e) {\r\n                if (e.dataTransfer && e.dataTransfer.types.indexOf(\"Files\")>-1) {\r\n                    enterdCount--\r\n                    if (enterdCount==0) {\r\n                        styler.removeClass(elm,hoverClass);\r\n                    }\r\n                }\r\n            });\r\n\r\n            on(elm, \"drop\", function(e) {\r\n                if (e.dataTransfer && e.dataTransfer.types.indexOf(\"Files\")>-1) {\r\n                    styler.removeClass(elm,hoverClass)\r\n                    eventer.stop(e);\r\n                    if (droppedCallback) {\r\n                        droppedCallback(e.dataTransfer.files);\r\n                    }\r\n                }\r\n            });\r\n\r\n\r\n            return this;\r\n        },\r\n\r\n        picker: function(elm, params) {\r\n            params = params || {};\r\n\r\n            var pickedCallback = params.picked;\r\n\r\n            on(elm, \"click\", function(e) {\r\n                e.preventDefault();\r\n                selectFile(pickedCallback);\r\n            });\r\n            return this;\r\n        },\r\n\r\n        readFile : function(file,params) {\r\n            params = params || {};\r\n            var d = new Deferred,\r\n                reader = new FileReader();\r\n            \r\n            reader.onload = function(evt) {\r\n                d.resolve(evt.target.result);\r\n            };\r\n            reader.onerror = function(e) {\r\n                var code = e.target.error.code;\r\n                if (code === 2) {\r\n                    alert('please don\\'t open this page using protocol fill:///');\r\n                } else {\r\n                    alert('error code: ' + code);\r\n                }\r\n            };\r\n            \r\n            if (params.asArrayBuffer){\r\n                reader.readAsArrayBuffer(file);\r\n            } else if (params.asDataUrl) {\r\n                reader.readAsDataURL(file);                \r\n            } else if (params.asText) {\r\n                reader.readAsText(file);\r\n            } else {\r\n                reader.readAsArrayBuffer(file);\r\n            }\r\n\r\n            return d.promise;\r\n        },\r\n\r\n        writeFile : function(data,name) {\r\n            if (window.navigator.msSaveBlob) { \r\n               if (langx.isString(data)) {\r\n                   data = dataURItoBlob(data);\r\n               }\r\n               window.navigator.msSaveBlob(data, name);\r\n            } else {\r\n                var a = document.createElement('a');\r\n                if (data instanceof Blob) {\r\n                    data = langx.URL.createObjectURL(data);\r\n                }\r\n                a.href = data;\r\n                a.setAttribute('download', name || 'noname');\r\n                a.dispatchEvent(new CustomEvent('click'));\r\n            }              \r\n        }\r\n\r\n\r\n    });\r\n\r\n    return skylark.filer = filer;\r\n});\r\n"]}