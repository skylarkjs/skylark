{"version":3,"sources":["http.js"],"names":["define","skylark","langx","empty","mimeToDataType","mime","split","scriptTypeRE","test","xmlTypeRE","appendQuery","url","query","replace","serializeData","options","processData","data","isString","$","param","traditional","type","toUpperCase","undefined","ajaxSuccess","xhr","settings","deferred","context","status","success","call","ajaxComplete","ajaxError","error","complete","ajax","mixin","Deferred","safeMixin","ajaxSettings","crossDomain","abortTimeout","dataType","accepts","headers","setHeader","name","value","toLowerCase","protocol","RegExp","$1","window","location","nativeSetHeader","setRequestHeader","mimeType","indexOf","overrideMimeType","contentType","onreadystatechange","readyState","clearTimeout","result","getResponseHeader","responseText","eval","responseXML","blankRE","JSON","parse","e","statusText","async","open","username","password","apply","timeout","setTimeout","abort","send","get","parseArguments","arguments","post","getJSON","http","beforeSend","global","XMLHttpRequest","script","json","xml","html","text","cache","gtJSON"],"mappings":"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","file":"../http.js","sourcesContent":["define([\n    \"./skylark\",\n    \"./langx\"\n],function(skylark, langx){\n    var Deferred = langx.Deferred,\n        blankRE = /^\\s*$/,\n        scriptTypeRE = /^(?:text|application)\\/javascript/i,\n        xmlTypeRE = /^(?:text|application)\\/xml/i;\n\n\n    function empty() {}\n\n    var ajaxSettings = {\n        // Default type of request\n        type: 'GET',\n        // Callback that is executed before request\n        beforeSend: empty,\n        // Callback that is executed if the request succeeds\n        success: empty,\n        // Callback that is executed the the server drops error\n        error: empty,\n        // Callback that is executed on request complete (both: error and success)\n        complete: empty,\n        // The context for the callbacks\n        context: null,\n        // Whether to trigger \"global\" Ajax events\n        global: true,\n        // Transport\n        xhr: function() {\n            return new window.XMLHttpRequest();\n        },\n        // MIME types mapping\n        // IIS returns Javascript as \"application/x-javascript\"\n        accepts: {\n            script: 'text/javascript, application/javascript, application/x-javascript',\n            json: 'application/json',\n            xml: 'application/xml, text/xml',\n            html: 'text/html',\n            text: 'text/plain'\n        },\n        // Whether the request is to another domain\n        crossDomain: false,\n        // Default timeout\n        timeout: 0,\n        // Whether data should be serialized to string\n        processData: true,\n        // Whether the browser should be allowed to cache GET responses\n        cache: true\n    }\n\n    function mimeToDataType(mime) {\n        if (mime) {\n            mime = mime.split(';', 2)[0];\n        }\n        return mime && (mime == 'text/html' ? 'html' :\n            mime == 'application/json' ? 'json' :\n            scriptTypeRE.test(mime) ? 'script' :\n            xmlTypeRE.test(mime) && 'xml') || 'text';\n    }\n\n    function appendQuery(url, query) {\n        if (query == '') {\n            return url;\n        }\n        return (url + '&' + query).replace(/[&?]{1,2}/, '?');\n    }\n\n    function serialize(params, obj, traditional, scope) {\n        var type, array = langx.isArray(obj),\n            hash = langx.isPlainObject(obj)\n        langx.each(obj, function(key, value) {\n            type = langx.type(value);\n            if (scope) {\n                key = traditional ? scope :\n                        scope + '[' + (hash || type == 'object' || type == 'array' ? key : '') + ']' ;\n            }\n            // handle data in serializeArray() format\n            if (!scope && array) {\n                params.add(value.name, value.value);\n            // recurse into nested objects\n            } else if (type == \"array\" || (!traditional && type == \"object\")) {\n                serialize(params, value, traditional, key);\n            } else {\n                params.add(key, value);\n            }\n        })\n    }    \n\n    function param(obj, traditional) {\n        var params = []\n        params.add = function(key, value) {\n            if (langx.isFunction(value)) {\n                value = value();\n            }\n            if (value == null) {\n                value = \"\";\n            }\n            this.push(escape(key) + '=' + escape(value));\n        }\n        \n        serialize(params, obj, traditional);\n\n        return params.join('&').replace(/%20/g, '+')\n    }\n\n    // serialize payload and append it to the URL for GET requests\n    function serializeData(options) {\n        if (options.processData && options.data && !langx.isString(options.data)) {\n            options.data = $.param(options.data, options.traditional)\n        }\n        if (options.data && (!options.type || options.type.toUpperCase() == 'GET')) {\n            options.url = appendQuery(options.url, options.data);\n            options.data = undefined;\n        }\n    }\n\n    function ajaxSuccess(data, xhr, settings, deferred) {\n        var context = settings.context,\n            status = 'success'\n        settings.success.call(context, data, status, xhr)\n        //if (deferred) deferred.resolveWith(context, [data, status, xhr])\n        //triggerGlobal(settings, context, 'ajaxSuccess', [xhr, settings, data])\n        ajaxComplete(status, xhr, settings)\n    }\n    // type: \"timeout\", \"error\", \"abort\", \"parsererror\"\n    function ajaxError(error, type, xhr, settings, deferred) {\n        var context = settings.context\n        settings.error.call(context, xhr, type, error)\n        //if (deferred) deferred.rejectWith(context, [xhr, type, error])\n        //triggerGlobal(settings, context, 'ajaxError', [xhr, settings, error || type])\n        ajaxComplete(type, xhr, settings)\n    }\n    // status: \"success\", \"notmodified\", \"error\", \"timeout\", \"abort\", \"parsererror\"\n    function ajaxComplete(status, xhr, settings) {\n        var context = settings.context\n        settings.complete.call(context, xhr, status)\n        //triggerGlobal(settings, context, 'ajaxComplete', [xhr, settings])\n        //ajaxStop(settings)\n    }    \n\n    function ajax(options) {\n        var settings = langx.mixin({}, options),\n            deferred = new Deferred();\n\n        langx.safeMixin(settings,ajaxSettings);\n\n        //ajaxStart(settings)\n        if (!settings.crossDomain) {\n        //    settings.crossDomain = !langx.isSameOrigin(settings.url);\n        }\n\n        serializeData(settings);\n        var dataType = settings.dataType;\n\n        var mime = settings.accepts[dataType],\n            headers = {},\n            setHeader = function(name, value) { headers[name.toLowerCase()] = [name, value] },\n            protocol = /^([\\w-]+:)\\/\\//.test(settings.url) ? RegExp.$1 : window.location.protocol,\n            xhr = settings.xhr(),\n            nativeSetHeader = xhr.setRequestHeader,\n            abortTimeout;\n\n        //if (deferred) deferred.promise(xhr)\n\n        if (!settings.crossDomain) {\n            setHeader('X-Requested-With', 'XMLHttpRequest');\n        }\n        setHeader('Accept', mime || '*/*')\n        if (mime = settings.mimeType || mime) {\n            if (mime.indexOf(',') > -1) mime = mime.split(',', 2)[0]\n            xhr.overrideMimeType && xhr.overrideMimeType(mime)\n        }\n        if (settings.contentType || (settings.contentType !== false && settings.data && settings.type.toUpperCase() != 'GET')) {\n            setHeader('Content-Type', settings.contentType || 'application/x-www-form-urlencoded')\n        }\n\n        if (settings.headers) {\n            for (name in settings.headers) {\n                setHeader(name, settings.headers[name]);\n            }    \n        }\n        xhr.setRequestHeader = setHeader;\n\n        xhr.onreadystatechange = function() {\n            if (xhr.readyState == 4) {\n                xhr.onreadystatechange = empty\n                clearTimeout(abortTimeout)\n                var result, error = false\n                if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304 || (xhr.status == 0 && protocol == 'file:')) {\n                    dataType = dataType || mimeToDataType(settings.mimeType || xhr.getResponseHeader('content-type'))\n                    result = xhr.responseText\n\n                    try {\n                        // http://perfectionkills.com/global-eval-what-are-the-options/\n                        if (dataType == 'script') {\n                            (1, eval)(result);\n                        } else if (dataType == 'xml') {\n                            result = xhr.responseXML\n                        } else if (dataType == 'json') {\n                            result = blankRE.test(result) ? null : JSON.parse(result);\n                        }\n                    } catch (e) { \n                        error = e \n                    }\n\n                    if (error) {\n                        ajaxError(error, 'parsererror', xhr, settings, deferred);\n                    } else {\n                        ajaxSuccess(result, xhr, settings, deferred);\n                    }\n                } else {\n                    ajaxError(xhr.statusText || null, xhr.status ? 'error' : 'abort', xhr, settings, deferred);\n                }\n            }\n        }\n\n        /*\n        if (ajaxBeforeSend(xhr, settings) === false) {\n            xhr.abort()\n            ajaxError(null, 'abort', xhr, settings, deferred)\n            return xhr\n        }\n\n        if (settings.xhrFields)\n            for (name in settings.xhrFields) xhr[name] = settings.xhrFields[name]\n        */\n        var async = 'async' in settings ? settings.async : true\n        xhr.open(settings.type, settings.url, async, settings.username, settings.password)\n\n        for (name in headers) {\n            nativeSetHeader.apply(xhr, headers[name]);\n        }\n\n        if (settings.timeout > 0) {\n            abortTimeout = setTimeout(function() {\n                xhr.onreadystatechange = empty;\n                xhr.abort();\n                ajaxError(null, 'timeout', xhr, settings, deferred);\n            }, settings.timeout);\n        }\n\n        // avoid sending empty string (#319)\n        xhr.send(settings.data ? settings.data : null)\n        return xhr;\n    }\n\n\n    function get( /* url, data, success, dataType */ ) {\n        return ajax(parseArguments.apply(null, arguments))\n    }\n\n    function post( /* url, data, success, dataType */ ) {\n        var options = parseArguments.apply(null, arguments);\n        options.type = 'POST';\n        return ajax(options);\n    }\n\n    function getJSON( /* url, data, success */ ) {\n        var options = parseArguments.apply(null, arguments);\n        options.dataType = 'json';\n        return ajax(options);\n    }    \n\n\n    function http(){\n      return http;\n    }\n\n    langx.mixin(http, {\n        ajax: ajax,\n\n        get: get,\n        \n        gtJSON: getJSON,\n\n        post: post\n\n    });\n\n    return skylark.http = http;\n});\n"]}