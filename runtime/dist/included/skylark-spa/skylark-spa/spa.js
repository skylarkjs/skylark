/**
 * skylark-spa - An Elegant  HTML5 Single Page Application Framework.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.1
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-router/router"],function(t,e,r){function n(t,r){var n=new CustomEvent(t,r);return e.safeMixin(n,r)}var i,o=e.Deferred,a=r.Route=r.Route.inherit({klassName:"SpaRoute",init:function(t,r){this.overrided(t,r),this.content=r.content,this.data=r.data;var n=this;["preparing","rendering","rendered"].forEach(function(t){e.isFunction(r[t])&&n.on(t,r[t])})},_entering:function(t){return this._prepared?this:this.prepare()},getConfigData:function(t){return t?this.data[t]:this.data},prepare:function(){var t=new o,e=this._setting,r=e.controller,i=this.controller,a=this;e.content,e.contentPath;return require([r.type],function(e){i=a.controller=new e(r),t.resolve()}),t.then(function(){var t=n("preparing",{route:a,result:!0});return a.trigger(t),o.when(t.result).then(function(){a._prepared=!0})})},render:function(t){var e=n("rendering",{route:this,context:t,content:this.content});return this.trigger(e),e.content},trigger:function(t){var e=this.controller;return e?e.perform(t):this.overrided(t)}}),s=e.Evented.inherit({klassName:"SpaRouteController",init:function(t,e){e=e||{},this.content=e.content,this.data=e.data},getConfigData:function(t){return t?this.data[t]:this.data},perform:function(t){var e=t.type;if(this[e])return this[e].call(this,t)}}),u=e.Evented.inherit({klassName:"SpaPage",init:function(t){t=e.mixin({routeViewer:"body"},t),this._params=t,this._rvc=document.querySelector(t.routeViewer),this._router=r,r.on("routed",e.proxy(this,"refresh"))},prepare:function(){},refresh:function(){var t=r.current(),i=(r.previous(),t.route.render(t));e.isString(i)?this._rvc.innerHTML=i:(this._rvc.innerHTML="",this._rvc.appendChild(i)),t.route.trigger(n("rendered",{route:t.route,content:i}))}}),h=e.Evented.inherit({klassName:"SpaPlugin",init:function(t,r){this.name=t,e.isString(r.hookers)&&(r.hookers=r.hookers.split(" ")),this._setting=r},isHooked:function(t){var e=this._setting.hookers||[];return e.indexOf(t)>-1},prepare:function(){var t=new o,i=this._setting,a=i.controller,s=this.controller,u=this;return require([a.type],function(n){s=u.controller=new n(a),r.on(i.hookers,{plugin:u},e.proxy(s.perform,s)),t.resolve()}),t.then(function(){var t=n("preparing",{plugin:u,result:!0});return u.trigger(t),o.when(t.result).then(function(){u._prepared=!0})})},trigger:function(t){var e=this.controller;return e?e.perform(t):this.overrided(t)}}),c=e.Evented.inherit({klassName:"SpaPluginController",init:function(t){this.plugin=t},perform:function(t){var e=t.type;if(this[e])return this[e].call(this,t)}}),p=e.Evented.inherit({klassName:"SpaApplication",init:function(t){if(i)return i;var n=this._plugins={};t=this._config=e.mixin({plugins:{}},t,!0),e.each(t.plugins,function(t,e){n[t]=new h(t,e)}),r.routes(t.routes),this._router=r,this._page=new l.Page(t.page),document.title=t.title;var o=t.baseUrl;void 0===o&&(o=t.baseUrl=new e.URL(document.baseURI).pathname),r.baseUrl(o),t.homePath&&r.homePath(t.homePath),i=this},getConfig:function(t){return t?this._config[t]:this._config},go:function(t){return r.go(t),this},page:function(){return this._page},prepare:function(){if(this._prepared)return o.resolve();var t=this,i=e.map(this._plugins,function(t,e){if(t.isHooked("starting"))return t.prepare()});return o.all(i).then(function(){r.trigger(n("starting",{spa:t}));var i=e.map(r.routes(),function(t,e){if(t.lazy===!1)return t.prepare()}),a=e.map(t._plugins,function(t,e){if(!t.isHooked("starting"))return t.prepare()});return o.all(i.concat(a)).then(function(){t._prepared=!0})})},run:function(){this._router.start(),r.trigger(n("started",{spa:this}))}}),l=function(t){return i||(window[t.name||"app"]=i=new l.Application(t)),i};return e.mixin(l,{Application:p,Page:u,Plugin:h,PluginController:c,Route:a,RouteController:s}),t.spa=l});
//# sourceMappingURL=sourcemaps/spa.js.map
